<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mynd — Emotional Clarity Engine™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="When you don’t know what’s wrong, Mynd helps you understand yourself—emotion, root cause, 90-second regulation, and one next step." />
  <style>
    :root{
      --bg:#0B1213; --card:#0F1A1C; --text:#E6F5F4; --muted:#8BA5A4;
      --soft:#B8D4D1; --accent:#19A19C; --line:#173033; --ring:#5ABBB4;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:880px;margin:0 auto;padding:32px 20px}
    .hero{padding:28px 24px;background:linear-gradient(180deg, rgba(25,161,156,0.06), rgba(15,26,28,0.6)), var(--card); border:1px solid #153235; border-radius:20px; box-shadow:0 18px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 6px;font-weight:700;letter-spacing:.2px}
    p.sub{color:var(--soft);margin:0 0 16px}
    textarea{width:100%;min-height:120px;background:#0B1213;border:1px solid #163236;color:var(--text);padding:14px 16px;border-radius:14px;font-size:16px;resize:vertical}
    button{background:var(--accent);color:#052025;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .sp{height:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#10242a;border:1px solid #264a53;color:#a9dbe0;font-size:12px}
    .hr{height:1px;background:#183135;margin:16px 0}
    .label{color:var(--soft);font-size:13px;text-transform:uppercase;letter-spacing:.4px}
    .affirm{font-weight:700}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .muted{color:var(--muted)}
    .tiny{color:#86a8a6;font-size:12px}
    .footer{color:#799996;font-size:12px;text-align:center;margin-top:24px}
    .hidden{display:none}
    .row{display:flex;gap:12px}
    .chat-badge{min-width:36px;height:36px;border-radius:10px;background:#173033;display:flex;align-items:center;justify-content:center;font-size:12px;color:#a9dbe0}
    .chat-badge.ai{background:#10242a}
    .chip{display:inline-block;border:1px solid #264a53;background:#10242a;color:#a9dbe0;border-radius:999px;padding:6px 10px;font-size:12px}
    a.btn-link{color:#052025;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- HERO -->
    <div class="hero">
      <h1>Mynd</h1>
      <p class="sub">When you don’t know what’s wrong, I help you understand yourself. Write one or two sentences—I'll reflect with clarity, care, and a next step.</p>
      <form id="clarity-form">
        <textarea id="feelings" placeholder="e.g. I’m spiralling about money and can’t think straight..."></textarea>
        <div class="row" style="margin-top:12px">
          <button type="submit">Find Clarity</button>
          <a class="pill" href="./">Reset</a>
          <span class="tiny" style="align-self:center;margin-left:auto;">Preview mode. Full reflection unlocks reframe, 90-sec regulation, next step & affirmation.</span>
        </div>
      </form>
    </div>

    <div class="sp"></div>

    <!-- RESULT -->
    <div id="result-card" class="card hidden">
      <div class="pill" id="label-pill">Emotion</div>
      <h2 style="margin:10px 0 6px">I’m hearing this:</h2>
      <p class="muted">Also called: <span id="aka"></span></p>
      <div class="hr"></div>

      <div class="grid">
        <div class="card" style="padding:14px;background:#0b1213">
          <div class="label">Why this happens</div>
          <div id="why"></div>
        </div>
        <div class="card" style="padding:14px;background:#0b1213">
          <div class="label">What your body is doing</div>
          <div id="nervous"></div>
        </div>
        <div class="card" style="padding:14px;background:#0b1213">
          <div class="label">What you need</div>
          <div id="need"></div>
        </div>
      </div>

      <!-- FULL CONTENT -->
      <div id="full-block" class="hidden">
        <div class="hr"></div>
        <h3>Gentle Reframe</h3>
        <p id="reframe"></p>

        <h3>Regulate (60–120s)</h3>
        <p id="regulate"></p>

        <h3>One next step</h3>
        <p id="next_step"></p>

        <h3>Affirmation</h3>
        <p class="affirm" id="affirmation"></p>
      </div>

      <!-- UPGRADE CTA -->
      <div id="upgrade-block" class="">
        <div class="hr"></div>
        <p><strong>Want the full reflection?</strong> Get the reframe, 90-second regulation, your next step, and an anchoring affirmation.</p>
        <p><a class="chip btn-link" href="./join.html">Unlock Full Reflection</a></p>
      </div>

      <div class="hr"></div>
      <p class="tiny">Mynd · Emotional Clarity Engine™ · Prototype v0.1</p>
    </div>

    <!-- JOURNAL CHAT -->
    <div id="chat-card" class="card hidden" style="margin-top:20px;">
      <div class="pill">Journal Chat (beta)</div>
      <h2 style="margin:10px 0 6px">Write to me like a journal. I’ll respond with care.</h2>

      <div id="chat-log" style="display:flex; flex-direction:column; gap:10px; max-height:360px; overflow:auto; padding:8px; background:#0b1213; border:1px solid #173033; border-radius:12px;">
        <!-- messages appended here -->
      </div>

      <form id="chat-form" class="row" style="margin-top:12px;">
        <input id="chat-input" type="text" placeholder="Type your journal entry..." style="flex:1; background:#0B1213; border:1px solid #163236; color:#E6F5F4; padding:12px 14px; border-radius:12px; font-size:16px;" />
        <button type="submit">Send</button>
      </form>

      <p class="tiny" style="margin-top:8px;">This is supportive, not clinical advice. If you’re in crisis or considering self-harm, please seek local emergency support immediately.</p>
    </div>

    <div class="footer">Built with care. Your feelings are welcome here.</div>
  </div>

  <script>
    // ------------------ DATA: Emotional Clarity Engine ------------------
    const CLARITY = {
      fear_anxiety: {
        label: "Fear / Anxiety",
        aka: ["panic","worry","dread","spiral"],
        why: "Your brain is predicting a threat and overestimating the danger to keep you safe. The mind is running ‘what-if’ loops because something feels uncertain or out of your control.",
        nervous_system: "Sympathetic activation (fight/flight): shallow breath, tight chest, scanning, restless energy.",
        need: "Safety, grounding, proof of support, smaller doable steps.",
        reframe: "You’re not broken. Your body is trying to protect you without accurate data. When you slow the body, the mind recalibrates.",
        regulate: "Place one hand on your chest, one on your belly. Inhale 4s, exhale 6s for 6–10 cycles. Name five stable things in your life right now.",
        next_step: "Break the issue into the smallest next action you can complete in under 5 minutes. Do only that.",
        affirmation: "I can slow down. I am safe enough in this moment."
      },
      sadness_grief: {
        label: "Sadness / Grief",
        aka: ["heavy","low","teary"],
        why: "You are metabolizing loss, unmet expectations, or a part of you that didn’t get what it needed. Grief is love with nowhere to go.",
        nervous_system: "Parasympathetic dominance / collapse: low energy, withdrawal, heaviness behind the eyes.",
        need: "Permission to feel, warmth, gentle contact, non-judgment.",
        reframe: "Nothing is wrong with you for feeling this way. The pain is evidence of your capacity to love.",
        regulate: "Soften your jaw. Rest a warm hand on your heart. Let 90 seconds of waves move through without fixing.",
        next_step: "Message someone safe: ‘I don’t need advice—just a little presence. Can you be with me?’",
        affirmation: "My feelings are allowed. I can let them move."
      },
      anger_boundary: {
        label: "Anger / Boundary Injury",
        aka: ["irritation","rage","resentment"],
        why: "Something crossed your values, limits, or dignity. Anger is a guardian asking for repair or distance.",
        nervous_system: "High sympathetic activation: heat, tension in jaw/shoulders, impulse to act.",
        need: "Respect, clarity, a boundary or a plan to restore integrity.",
        reframe: "Anger is not the problem; misdirection is. You can harness it into clean action.",
        regulate: "Square breath (4-4-4-4) for 8 rounds. Shake arms for 20s. Exhale with a gentle ‘huh’.",
        next_step: "Write one sentence boundary you can communicate calmly: ‘I won’t discuss X when voices are raised. Let’s pause and revisit tomorrow.’",
        affirmation: "My energy is sacred. I can protect it without harming myself or others."
      },
      shame_guilt: {
        label: "Shame / Guilt",
        aka: ["I’m the problem","I failed","I’m not enough"],
        why: "Your inner protector believes criticism will keep you safe or acceptable. Shame confuses ‘I did something’ with ‘I am something’.",
        nervous_system: "Collapse/freeze: head down, avoidance, small voice.",
        need: "Accurate responsibility, compassion, repair where appropriate.",
        reframe: "You are not your mistake. Responsibility restores dignity; shame only shrinks your life.",
        regulate: "Sit upright, lengthen spine. Name three times you acted with integrity this week.",
        next_step: "If repair is needed, send a simple, honest message. If not, practice self-forgiveness: write ‘I release the part that believes I am unworthy.’",
        affirmation: "I can make amends and still belong."
      },
      confusion_overwhelm: {
        label: "Confusion / Overwhelm",
        aka: ["stuck","foggy","too much"],
        why: "Your brain is holding too many open tabs. Competing priorities, perfectionism, or fear of the ‘wrong’ choice stalls action.",
        nervous_system: "Mixed activation: racing thoughts + low motivation.",
        need: "Reduce inputs, choose one thing, time-bound focus.",
        reframe: "You don’t need the whole plan. You need the next honest step.",
        regulate: "Close your eyes for 30s. Then write the ONE outcome that matters today.",
        next_step: "Set a 10-minute timer. Do the smallest slice. Stop when the timer ends.",
        affirmation: "Clarity grows as I move."
      },
      lonely_abandoned: {
        label: "Loneliness / Abandonment",
        aka: ["unseen","left out","unloved"],
        why: "An attachment wound is touched: the nervous system expects disconnection. Old memories color the present.",
        nervous_system: "Heightened sensitivity to cues of distance; ache in chest/throat.",
        need: "Co-regulation, warmth, cues of belonging.",
        reframe: "Your longing is sacred—it points to your capacity to bond, not your lack of worth.",
        regulate: "Havening: gently stroke upper arms 60–90s while breathing slowly; say, ‘I’m here with you.’",
        next_step: "Ask for contact directly: ‘Can we share 10 minutes on the phone? I’d love connection.’",
        affirmation: "I am worthy of safe, consistent love."
      },
      stress_burnout: {
        label: "Stress / Burnout",
        aka: ["fried","over it","no capacity"],
        why: "Sustained output without replenishment. Your body is signaling a need to downshift and re-resource.",
        nervous_system: "Chronic sympathetic → fatigue, irritability, poor focus.",
        need: "Permission to pause, basics (sleep, food, water, sunlight), adjusted expectations.",
        reframe: "Rest is productive when it protects the engine that builds your life.",
        regulate: "Two-minute physiological sighs: inhale, short top-up inhale, long slow exhale. Repeat 6–8 times.",
        next_step: "Cancel one non-essential commitment. Put a 20-minute ‘nothing block’ on your calendar today.",
        affirmation: "My worth is not measured by output."
      },
      heartbreak_loss: {
        label: "Heartbreak / Loss",
        aka: ["broken","devastated","bereft"],
        why: "Attachment has ruptured or a dream dissolved. The nervous system mourns the future that won’t happen.",
        nervous_system: "Waves of grief, intrusive recall, emptiness.",
        need: "Ritual, meaning-making, compassionate pacing.",
        reframe: "This pain is love trying to reorganize itself. It will reshape, not erase, your heart.",
        regulate: "Hold a keepsake; say what you’re grieving out loud. Let tears be a completion signal, not an enemy.",
        next_step: "Create a tiny ritual (candle, song, letter) to honor what was real.",
        affirmation: "I can love what was and still choose what’s next."
      },
      jealousy_comparison: {
        label: "Jealousy / Comparison",
        aka: ["envy","behind","less than"],
        why: "Someone else’s life mirrors a disowned desire. The pain points toward what you want to claim.",
        nervous_system: "Tension + self-criticism loop.",
        need: "Ownership of desire, self-compassion, a plan that is yours.",
        reframe: "Envy is a compass. It shows you the shape of your next chapter.",
        regulate: "Hand on heart: ‘It’s safe to want.’ Breathe 4/6 for ten cycles.",
        next_step: "Write one sentence: ‘I want ___ because ___.’ Choose the smallest step toward it.",
        affirmation: "Desire is allowed. My path is mine."
      },
      numb_dissociate: {
        label: "Numb / Dissociated",
        aka: ["checked out","can’t feel","blank"],
        why: "Your system hit capacity and protected you by disconnecting. This is adaptive, not a flaw.",
        nervous_system: "Dorsal vagal: low tone, fog, no impulse.",
        need: "Gentle activation: light, warmth, movement, sound.",
        reframe: "Numbness is your body guarding your heart. We’ll come back online slowly.",
        regulate: "Cold water on wrists, sunlight at a window, sway side-to-side for 60s, hum quietly.",
        next_step: "Two-minute sensory walk: name 5 things you see, 4 feel, 3 hear, 2 smell, 1 taste.",
        affirmation: "I can return to myself at my own pace."
      },
      hopeless_despair: {
        label: "Hopeless / Despair",
        aka: ["why try","done","nothing works"],
        why: "The brain has generalized past pain into ‘permanent.’ It cannot imagine novelty from inside exhaustion.",
        nervous_system: "Collapse, global negative bias.",
        need: "Tiny proof of agency, co-regulation, future seed.",
        reframe: "Hopelessness is a state, not a fact. It shifts when your body feels one real win.",
        regulate: "Sit up, feet on floor. Name one thing you can influence in the next hour.",
        next_step: "Choose a 2-minute task (drink water, open window, text a friend ‘thinking of you’). Complete it and notice your state.",
        affirmation: "I only need one step. Life can open again."
      }
    };

    const KEYWORDS = {
      fear_anxiety: [/\banx(iou|iet)y\b/i, /\bpanic\b/i, /\bworry|worried|worrying\b/i, /\bdread\b/i, /\bscared|afraid\b/i, /\bspiral(ing)?\b/i],
      sadness_grief: [/\bsad(ness)?\b/i, /\bgrief|grieving\b/i, /\blow\b/i, /\bcry|teary\b/i, /\bheavy\b/i],
      anger_boundary: [/\banger|angry|furious|rage\b/i, /\bresent(ful|ment)\b/i, /\bdisrespect(ed)?\b/i, /\bboundar(y|ies)\b/i, /\bmad\b/i],
      shame_guilt: [/\bshame(d)?\b/i, /\bguilt(y)?\b/i, /I(’|'|`)m the problem/i, /\bworthless|not enough\b/i, /\bfailed|failure\b/i],
      confusion_overwhelm: [/\boverwhelm(ed|ing)?\b/i, /\bconfus(ed|ion)\b/i, /\bstuck\b/i, /\bfog(gy)?\b/i, /\btoo much\b/i],
      lonely_abandoned: [/\blonely\b/i, /\babandon(ed|ment)\b/i, /\bunseen\b/i, /\bleft out\b/i, /\bunloved\b/i],
      stress_burnout: [/\bstress(ed|ful)?\b/i, /\bburnout|burnt out|burned out\b/i, /\bfried\b/i, /\bexhaust(ed|ion)\b/i],
      heartbreak_loss: [/\bheartbreak|heartbroken\b/i, /\bloss\b/i, /\bdevastat(ed|ing)\b/i, /\bbereft\b/i],
      jealousy_comparison: [/\bjealous(y)?\b/i, /\benvy|envious\b/i, /\bcompare|comparison\b/i, /\bbehind\b/i],
      numb_dissociate: [/\bnumb\b/i, /\bdissociat(e|ed|ing|ion)\b/i, /\bblank\b/i, /can(’|'|`)t feel/i],
      hopeless_despair: [/\bhopeless\b/i, /\bdespair\b/i, /\bwhy try\b/i, /\bnothing works\b/i, /\bdone\b/i]
    };

    function detectEmotion(text){
      const scores = Object.fromEntries(Object.keys(CLARITY).map(k => [k,0]));
      for (const [key, patterns] of Object.entries(KEYWORDS)) {
        for (const pat of patterns) if (pat.test(text)) scores[key] += 1;
      }
      let best = "confusion_overwhelm";
      let bestScore = -1;
      const priority = ["hopeless_despair","numb_dissociate","fear_anxiety","sadness_grief","anger_boundary","shame_guilt","lonely_abandoned","stress_burnout","heartbreak_loss","jealousy_comparison","confusion_overwhelm"];
      for (const [k, v] of Object.entries(scores)) {
        const tieBreaker = -priority.indexOf(k);
        const current = (v * 1000) + tieBreaker;
        if (current > bestScore) { bestScore = current; best = k; }
      }
      const sum = Object.values(scores).reduce((a,b)=>a+b,0);
      return sum === 0 ? "confusion_overwhelm" : best;
    }
    function qs(name){ return new URLSearchParams(location.search).get(name) }

    // ------------------ CLARITY FORM ------------------
    const form = document.getElementById('clarity-form');
    const resultCard = document.getElementById('result-card');
    const chatCard = document.getElementById('chat-card');

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const t = document.getElementById('feelings').value.trim();
      if(!t) return;

      const key = detectEmotion(t.toLowerCase());
      window.__lastEmotionKey = key;

      const d = CLARITY[key];
      resultCard.classList.remove('hidden');
      document.getElementById('label-pill').textContent = d.label;
      document.getElementById('aka').textContent = d.aka.join(', ');
      document.getElementById('why').textContent = d.why;
      document.getElementById('nervous').textContent = d.nervous_system;
      document.getElementById('need').textContent = d.need;

      const isFull = qs('full') === '1';
      const fullBlock = document.getElementById('full-block');
      const upgradeBlock = document.getElementById('upgrade-block');

      if(isFull){
        fullBlock.classList.remove('hidden');
        upgradeBlock.classList.add('hidden');
        document.getElementById('reframe').textContent = d.reframe;
        document.getElementById('regulate').textContent = d.regulate;
        document.getElementById('next_step').textContent = d.next_step;
        document.getElementById('affirmation').textContent = '“' + d.affirmation + '”';
      } else {
        fullBlock.classList.add('hidden');
        upgradeBlock.classList.remove('hidden');
      }

      // Reveal chat
      chatCard.classList.remove('hidden');
    });

    // ------------------ JOURNAL CHAT ------------------
    const CHAT_KEY = 'mynd_chat_history_v1';
    const chatLogEl = document.getElementById('chat-log');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    function loadChat(){ try{ return JSON.parse(localStorage.getItem(CHAT_KEY)||'[]'); }catch{return []} }
    function saveChat(h){ localStorage.setItem(CHAT_KEY, JSON.stringify(h)); }
    function appendMsg(role, text){
      const row = document.createElement('div'); row.className='row';
      const badge = document.createElement('div');
      badge.className = 'chat-badge' + (role==='assistant'?' ai':'');
      badge.textContent = role==='user' ? 'You' : 'AI';
      const bubble = document.createElement('div');
      bubble.style.background = '#0f1a1c';
      bubble.style.border = '1px solid #173033';
      bubble.style.padding = '10px 12px';
      bubble.style.borderRadius = '12px';
      bubble.style.whiteSpace = 'pre-wrap';
      bubble.textContent = text;
      row.appendChild(badge); row.appendChild(bubble);
      chatLogEl.appendChild(row);
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }

    const history = loadChat();
    if (history.length){
      chatCard.classList.remove('hidden');
      history.forEach(m => appendMsg(m.role, m.content));
    }

    chatForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const content = chatInput.value.trim();
      if(!content) return;

      appendMsg('user', content);
      history.push({role:'user', content});
      saveChat(history);
      chatInput.value = '';

      // ---- EDIT THIS: your Cloudflare Worker endpoint URL
      const WORKER_URL = 'https://YOUR_WORKER_SUBDOMAIN.workers.dev/api/chat';

      // Loading placeholder
      appendMsg('assistant', '…');

      try {
        const payload = {
          messages: history.slice(-10), // last 10 turns
          context: {
            emotionKey: window.__lastEmotionKey || null,
            page: 'index',
            fullMode: (qs('full') === '1')
          }
        };
        const res = await fetch(WORKER_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        // replace last assistant placeholder with actual text
        chatLogEl.lastChild.remove();
        const reply = data.reply || 'I’m here with you. Try sending that again if the connection hiccuped.';
        appendMsg('assistant', reply);
        history.push({role:'assistant', content: reply});
        saveChat(history);
      } catch (err){
        chatLogEl.lastChild.remove();
        appendMsg('assistant', 'I couldn’t reach the chat service. Please try again in a moment.');
      }
    });
  </script>
</body>
</html>
